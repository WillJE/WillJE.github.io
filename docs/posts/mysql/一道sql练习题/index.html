<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#fcfcfc">
	<meta name="msapplication-TileColor" content="#fcfcfc">
<meta itemprop="name" content="">
<meta itemprop="description" content="表结构 有三张表：students学生表,courses课程表,scores成绩表，三个表的结构如下：
students:  courses:  scores:  1. 输出成绩表，按照 姓名,课程名,成绩 的格式输出  第一个题目很简单，要求输出学生姓名，课程名，以及每位同学的成绩，因此只需要把成绩表和学生表，课程表链接，分别获取学生名，课程名即可。
select s.name,c.name,sc.scorefrom scores scleft join students s on sc.sid = s.idleft join course c on sc.cid = c.id;2. 输出每科的第一名，按照 课程名,学生名,成绩 的格式输出  相对于第一个题目，难度稍加，但逻辑也非常简单。
很多同学在这个题目上折了，并不是因为不会写求第一名的SQL，而是因为其对SQL的group by理解不透彻导致的。
写出如下SQL：
select s.name,c.name,max(sc.score) scorefrom scores scinner join students s on sc.sid = s.idinner join course c on sc.cid = c.idgroup by sc.cid;这个SQL看上去好像没什么问题，成绩表连接学生表，连接课程表，分别拿到学生名，课程名，然后使用max函数求出每科的最高成绩，按科目分组。
可是，这个sql在实际运行时却报错：
[42000][1055] Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column &#39;test.s.name&#39; which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by有的同学说，哎，这是mysql的一个sql_mode=only_full_group_by导致的，把这个模式改了就不报错，正常运行了。
真的是这样么？这么回答的同学基本是没理解sql里面group by。
group by 是分组操作，它要求被select的列要么在group by后面，要么在聚合函数里面，否则就会上面的错误。上面的错误是说s.name这个字段，没有在group by里面，也没有在聚合函数里面。
为什么会这样？
想一下group by的逻辑，它是分组操作，对于一个表中的数据，按照某个字段分组后，每个分组都会有多条记录，接下来的操作，是对每个分组的多条记录进行聚合操作，而不能单独对某个字段进行操作。因为这个字段和被分组的字段，不一定是一一对应的，如果不是一一对应的，单独select这个字段的时候，mysql怎么会知道要取这个分组中的哪一条呢？
这也就是为什么mysql中会有sql_mode这个设置，如果你确定你单独select的字段和要分组的字段是一一对应的，你可以打开这个设置，让mysql不再运行报错。但如果是某个同学对group by理解不深入，打开这个设置很容易导致，sql查询不报错，但是查出来的数据却不对，这种问题很难去排查，所以建议这个设置就是用only_full_group_by这个模式。mysql可以允许自己设置，postgresql直接就不允许用户自己设置，严格按照group by的逻辑来。
上面sql中，s.name, c.name两个字段，都不在group by后面或者不再聚合函数后面，因此运行肯定会报错。
正确的做法是，先从scores成绩表中查出每科第一名，然后再和scores自己连，查出对应的学生id，然后再和学生表，成绩表连接，得出学生名，课程名。
select c.name,s.name,sc.scorefrom scores scright join (select sc.cid,max(sc.score) as scorefrom scores scgroup by sc.cid) tmp on sc.cid = tmp.cid and sc.score=tmp.scoreinner join course c on sc.cid = c.idinner join students s on sc.sid = s.idorder by c.name;子查询中，根据cid进行分组，获取每个分组下的最大成绩（也就是每个科目的最高成绩），然后和scores,students,courses连接，查询出对应的学生名，课程名和成绩即可。
3. 输出每科成绩的前三名  这个题目，相对于上面一个，又进一步。上面只是求每科的第一名，这个要求输出前三名。
这个也是group by ，然后limit 3么？limit 3的话只输出最终结果的3条，并不满足每个科目的前三名。
那该如何做呢？这里就得需要知道，mysql里的自定义变量了，使用自定义变量来统计排名。
怎么做呢？首先，我们先将每个科目按照成绩排名。
select sc.">

<meta itemprop="wordCount" content="472">
<meta itemprop="keywords" content="" /><meta property="og:title" content="" />
<meta property="og:description" content="表结构 有三张表：students学生表,courses课程表,scores成绩表，三个表的结构如下：
students:  courses:  scores:  1. 输出成绩表，按照 姓名,课程名,成绩 的格式输出  第一个题目很简单，要求输出学生姓名，课程名，以及每位同学的成绩，因此只需要把成绩表和学生表，课程表链接，分别获取学生名，课程名即可。
select s.name,c.name,sc.scorefrom scores scleft join students s on sc.sid = s.idleft join course c on sc.cid = c.id;2. 输出每科的第一名，按照 课程名,学生名,成绩 的格式输出  相对于第一个题目，难度稍加，但逻辑也非常简单。
很多同学在这个题目上折了，并不是因为不会写求第一名的SQL，而是因为其对SQL的group by理解不透彻导致的。
写出如下SQL：
select s.name,c.name,max(sc.score) scorefrom scores scinner join students s on sc.sid = s.idinner join course c on sc.cid = c.idgroup by sc.cid;这个SQL看上去好像没什么问题，成绩表连接学生表，连接课程表，分别拿到学生名，课程名，然后使用max函数求出每科的最高成绩，按科目分组。
可是，这个sql在实际运行时却报错：
[42000][1055] Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column &#39;test.s.name&#39; which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by有的同学说，哎，这是mysql的一个sql_mode=only_full_group_by导致的，把这个模式改了就不报错，正常运行了。
真的是这样么？这么回答的同学基本是没理解sql里面group by。
group by 是分组操作，它要求被select的列要么在group by后面，要么在聚合函数里面，否则就会上面的错误。上面的错误是说s.name这个字段，没有在group by里面，也没有在聚合函数里面。
为什么会这样？
想一下group by的逻辑，它是分组操作，对于一个表中的数据，按照某个字段分组后，每个分组都会有多条记录，接下来的操作，是对每个分组的多条记录进行聚合操作，而不能单独对某个字段进行操作。因为这个字段和被分组的字段，不一定是一一对应的，如果不是一一对应的，单独select这个字段的时候，mysql怎么会知道要取这个分组中的哪一条呢？
这也就是为什么mysql中会有sql_mode这个设置，如果你确定你单独select的字段和要分组的字段是一一对应的，你可以打开这个设置，让mysql不再运行报错。但如果是某个同学对group by理解不深入，打开这个设置很容易导致，sql查询不报错，但是查出来的数据却不对，这种问题很难去排查，所以建议这个设置就是用only_full_group_by这个模式。mysql可以允许自己设置，postgresql直接就不允许用户自己设置，严格按照group by的逻辑来。
上面sql中，s.name, c.name两个字段，都不在group by后面或者不再聚合函数后面，因此运行肯定会报错。
正确的做法是，先从scores成绩表中查出每科第一名，然后再和scores自己连，查出对应的学生id，然后再和学生表，成绩表连接，得出学生名，课程名。
select c.name,s.name,sc.scorefrom scores scright join (select sc.cid,max(sc.score) as scorefrom scores scgroup by sc.cid) tmp on sc.cid = tmp.cid and sc.score=tmp.scoreinner join course c on sc.cid = c.idinner join students s on sc.sid = s.idorder by c.name;子查询中，根据cid进行分组，获取每个分组下的最大成绩（也就是每个科目的最高成绩），然后和scores,students,courses连接，查询出对应的学生名，课程名和成绩即可。
3. 输出每科成绩的前三名  这个题目，相对于上面一个，又进一步。上面只是求每科的第一名，这个要求输出前三名。
这个也是group by ，然后limit 3么？limit 3的话只输出最终结果的3条，并不满足每个科目的前三名。
那该如何做呢？这里就得需要知道，mysql里的自定义变量了，使用自定义变量来统计排名。
怎么做呢？首先，我们先将每个科目按照成绩排名。
select sc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willje.github.io/posts/mysql/%E4%B8%80%E9%81%93sql%E7%BB%83%E4%B9%A0%E9%A2%98/" /><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="表结构 有三张表：students学生表,courses课程表,scores成绩表，三个表的结构如下：
students:  courses:  scores:  1. 输出成绩表，按照 姓名,课程名,成绩 的格式输出  第一个题目很简单，要求输出学生姓名，课程名，以及每位同学的成绩，因此只需要把成绩表和学生表，课程表链接，分别获取学生名，课程名即可。
select s.name,c.name,sc.scorefrom scores scleft join students s on sc.sid = s.idleft join course c on sc.cid = c.id;2. 输出每科的第一名，按照 课程名,学生名,成绩 的格式输出  相对于第一个题目，难度稍加，但逻辑也非常简单。
很多同学在这个题目上折了，并不是因为不会写求第一名的SQL，而是因为其对SQL的group by理解不透彻导致的。
写出如下SQL：
select s.name,c.name,max(sc.score) scorefrom scores scinner join students s on sc.sid = s.idinner join course c on sc.cid = c.idgroup by sc.cid;这个SQL看上去好像没什么问题，成绩表连接学生表，连接课程表，分别拿到学生名，课程名，然后使用max函数求出每科的最高成绩，按科目分组。
可是，这个sql在实际运行时却报错：
[42000][1055] Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column &#39;test.s.name&#39; which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by有的同学说，哎，这是mysql的一个sql_mode=only_full_group_by导致的，把这个模式改了就不报错，正常运行了。
真的是这样么？这么回答的同学基本是没理解sql里面group by。
group by 是分组操作，它要求被select的列要么在group by后面，要么在聚合函数里面，否则就会上面的错误。上面的错误是说s.name这个字段，没有在group by里面，也没有在聚合函数里面。
为什么会这样？
想一下group by的逻辑，它是分组操作，对于一个表中的数据，按照某个字段分组后，每个分组都会有多条记录，接下来的操作，是对每个分组的多条记录进行聚合操作，而不能单独对某个字段进行操作。因为这个字段和被分组的字段，不一定是一一对应的，如果不是一一对应的，单独select这个字段的时候，mysql怎么会知道要取这个分组中的哪一条呢？
这也就是为什么mysql中会有sql_mode这个设置，如果你确定你单独select的字段和要分组的字段是一一对应的，你可以打开这个设置，让mysql不再运行报错。但如果是某个同学对group by理解不深入，打开这个设置很容易导致，sql查询不报错，但是查出来的数据却不对，这种问题很难去排查，所以建议这个设置就是用only_full_group_by这个模式。mysql可以允许自己设置，postgresql直接就不允许用户自己设置，严格按照group by的逻辑来。
上面sql中，s.name, c.name两个字段，都不在group by后面或者不再聚合函数后面，因此运行肯定会报错。
正确的做法是，先从scores成绩表中查出每科第一名，然后再和scores自己连，查出对应的学生id，然后再和学生表，成绩表连接，得出学生名，课程名。
select c.name,s.name,sc.scorefrom scores scright join (select sc.cid,max(sc.score) as scorefrom scores scgroup by sc.cid) tmp on sc.cid = tmp.cid and sc.score=tmp.scoreinner join course c on sc.cid = c.idinner join students s on sc.sid = s.idorder by c.name;子查询中，根据cid进行分组，获取每个分组下的最大成绩（也就是每个科目的最高成绩），然后和scores,students,courses连接，查询出对应的学生名，课程名和成绩即可。
3. 输出每科成绩的前三名  这个题目，相对于上面一个，又进一步。上面只是求每科的第一名，这个要求输出前三名。
这个也是group by ，然后limit 3么？limit 3的话只输出最终结果的3条，并不满足每个科目的前三名。
那该如何做呢？这里就得需要知道，mysql里的自定义变量了，使用自定义变量来统计排名。
怎么做呢？首先，我们先将每个科目按照成绩排名。
select sc."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title></title>
	<link rel="stylesheet" href="https://willje.github.io/css/style.min.d3141168199607bf3a517216ce3c263814eecdbc8fca72a9a88700799a838219.css" integrity="sha256-0xQRaBmWB786UXIWzjwmOBTuzbyPynKpqIcAeZqDghk=" crossorigin="anonymous">
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
	<link rel="stylesheet" href="https://willje.github.io/css/styles.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://willje.github.io">will&#39;s blog</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
  <a href="https://willje.github.io/">首页</a>
  <a href="https://willje.github.io/posts/">归档</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="menu-btn" class="hdr-btn" title="菜单"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://willje.github.io/">首页</a></li>
			<li><a href="https://willje.github.io/posts/">归档</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jan 1, 0001</span></div>
				<h1></h1>
			</header>
			<div class="content">
				<h2 id="表结构">表结构<a href="#表结构" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>有三张表：students学生表,courses课程表,scores成绩表，三个表的结构如下：</p>
<p>students:
<a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_08-53-54.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_08-53-54.png"
    alt="students"  />
</p>
</a>
</p>
<p>courses:
<a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_08-57-35.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_08-57-35.png"
    alt="courses"  />
</p>
</a>
</p>
<p>scores:
<a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_08-58-24.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_08-58-24.png"
    alt="scores"  />
</p>
</a>
</p>
<h3 id="1-输出成绩表按照-姓名课程名成绩-的格式输出">1. 输出成绩表，按照 姓名,课程名,成绩 的格式输出<a href="#1-输出成绩表按照-姓名课程名成绩-的格式输出" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_09-01-31.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_09-01-31.png"
    alt="1"  />
</p>
</a>
</p>
<p>第一个题目很简单，要求输出学生姓名，课程名，以及每位同学的成绩，因此只需要把成绩表和学生表，课程表链接，分别获取学生名，课程名即可。</p>
<pre><code>select s.name,c.name,sc.score
from scores sc
       left join students s on sc.sid = s.id
       left join course c on sc.cid = c.id;
</code></pre><h3 id="2-输出每科的第一名按照-课程名学生名成绩-的格式输出">2. 输出每科的第一名，按照 课程名,学生名,成绩 的格式输出<a href="#2-输出每科的第一名按照-课程名学生名成绩-的格式输出" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_09-06-19.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_09-06-19.png"
    alt="第一名"  />
</p>
</a>
</p>
<p>相对于第一个题目，难度稍加，但逻辑也非常简单。</p>
<p>很多同学在这个题目上折了，并不是因为不会写求第一名的SQL，而是因为其对SQL的group by理解不透彻导致的。</p>
<p>写出如下SQL：</p>
<pre><code>select s.name,c.name,max(sc.score) score
from scores sc
       inner join students s on sc.sid = s.id
       inner join course c on sc.cid = c.id
group by sc.cid;
</code></pre><p>这个SQL看上去好像没什么问题，成绩表连接学生表，连接课程表，分别拿到学生名，课程名，然后使用max函数求出每科的最高成绩，按科目分组。</p>
<p>可是，这个sql在实际运行时却报错：</p>
<pre><code>[42000][1055] Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'test.s.name' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by
</code></pre><p>有的同学说，哎，这是mysql的一个sql_mode=only_full_group_by导致的，把这个模式改了就不报错，正常运行了。</p>
<p>真的是这样么？这么回答的同学基本是没理解sql里面group by。</p>
<p>group by 是分组操作，它要求被select的列要么在group by后面，要么在聚合函数里面，否则就会上面的错误。上面的错误是说s.name这个字段，没有在group by里面，也没有在聚合函数里面。</p>
<p>为什么会这样？</p>
<p>想一下group by的逻辑，它是分组操作，对于一个表中的数据，按照某个字段分组后，每个分组都会有多条记录，接下来的操作，是对每个分组的多条记录进行聚合操作，而不能单独对某个字段进行操作。因为这个字段和被分组的字段，不一定是一一对应的，如果不是一一对应的，单独select这个字段的时候，mysql怎么会知道要取这个分组中的哪一条呢？</p>
<p>这也就是为什么mysql中会有sql_mode这个设置，如果你确定你单独select的字段和要分组的字段是一一对应的，你可以打开这个设置，让mysql不再运行报错。但如果是某个同学对group by理解不深入，打开这个设置很容易导致，sql查询不报错，但是查出来的数据却不对，这种问题很难去排查，所以建议这个设置就是用only_full_group_by这个模式。mysql可以允许自己设置，postgresql直接就不允许用户自己设置，严格按照group by的逻辑来。</p>
<p>上面sql中，s.name, c.name两个字段，都不在group by后面或者不再聚合函数后面，因此运行肯定会报错。</p>
<p>正确的做法是，先从scores成绩表中查出每科第一名，然后再和scores自己连，查出对应的学生id，然后再和学生表，成绩表连接，得出学生名，课程名。</p>
<pre><code>select c.name,s.name,sc.score
from scores sc
       right join (
  select sc.cid,max(sc.score) as score
  from scores sc
  group by sc.cid
) tmp on sc.cid = tmp.cid and sc.score=tmp.score
       inner join course c on sc.cid = c.id
       inner join students s on sc.sid = s.id
order by c.name;
</code></pre><p>子查询中，根据cid进行分组，获取每个分组下的最大成绩（也就是每个科目的最高成绩），然后和scores,students,courses连接，查询出对应的学生名，课程名和成绩即可。</p>
<h3 id="3-输出每科成绩的前三名">3. 输出每科成绩的前三名<a href="#3-输出每科成绩的前三名" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_09-37-09.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_09-37-09.png"
    alt="前三名"  />
</p>
</a>
</p>
<p>这个题目，相对于上面一个，又进一步。上面只是求每科的第一名，这个要求输出前三名。</p>
<p>这个也是group by ，然后limit 3么？limit 3的话只输出最终结果的3条，并不满足每个科目的前三名。</p>
<p>那该如何做呢？这里就得需要知道，mysql里的自定义变量了，使用自定义变量来统计排名。</p>
<p>怎么做呢？首先，我们先将每个科目按照成绩排名。</p>
<pre><code>select sc.cid,
       sc.sid,
       sc.score,
       case
         when @cid = (@cid := sc.cid) and @pre != (@pre := sc.score) then @`rank` := @`rank` + 1
         when @cid = (@cid := sc.cid) and @pre = (@pre := sc.score) then @`rank` := @`rank`
         else @`rank` := 1 end as `rank`
from scores sc,
     (select @`rank` := 0, @cid := 0, @pre := -1) init
order by sc.cid, sc.score desc;
</code></pre><p>我们定义三个变量，rank,cid,pre来代指排名，当前的课程id，以及前一个分数。</p>
<p>sql中有一个case when的判断，这里能够判断的前提是，我们根据cid和score desc做了排序。</p>
<p>排序后，如果cid相等，但是分数不相等，那么排名+1。如果分数相等，且分数也相等，那么排名不变。否则排名设置为1。</p>
<p>上面查出的结果大概如下：</p>
<p><a href="https://img001-10042971.cos.ap-shanghai.myqcloud.com/blog/ccsite/sql-test/Xnip2020-03-23_09-49-47.png" target="_blank" rel="noopener"><p class="md__image">
  <img src="../%e4%b8%80%e9%81%93SQL%e7%bb%83%e4%b9%a0%e9%a2%98.assets/Xnip2020-03-23_09-49-47.png"
    alt="img"  />
</p>
</a>
</p>
<p>上面这个结构，不是最终结果，但确实至关重要的一步中间结果。</p>
<p>有了上面这个中间结果，我们就可以连接students，courses表，将学生名，课程名取出来。</p>
<pre><code>select c.name,s.name,tmp.score,tmp.`rank`
from (
       select sc.cid,
              sc.sid,
              sc.score,
              case
                when @cid = (@cid := sc.cid) and @pre != (@pre := sc.score) then @`rank` := @`rank` + 1
                when @cid = (@cid := sc.cid) and @pre = (@pre := sc.score) then @`rank` := @`rank`
                else @`rank` := 1 end as `rank`
       from scores sc,
            (select @`rank` := 0, @cid := 0, @pre := -1) init
       order by sc.cid, sc.score desc
     ) tmp
       left join course c on tmp.cid = c.id
       left join students s on tmp.sid = s.id
where tmp.`rank` in (1, 2, 3);
</code></pre><h3 id="4-得过第一最多的同学">4. 得过第一最多的同学<a href="#4-得过第一最多的同学" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>有了上面排名的这个sql，统计排名第一最多的就简单了，直接按照sid，统计一下每个人排名第一的课程有多少即可。</p>
<pre><code>select tmp.sid, count(1) as count
from (
       select sc.cid,
              sc.sid,
              sc.score,
              case
                when @cid = (@cid := sc.cid) and @pre != (@pre := sc.score) then @`rank` := @`rank` + 1
                when @cid = (@cid := sc.cid) and @pre = (@pre := sc.score) then @`rank` := @`rank`
                else @`rank` := 1 end as `rank`
       from scores sc,
            (select @`rank` := 0, @cid := 0, @pre := -1) init
       order by sc.cid, sc.score desc
     ) tmp
where tmp.`rank` = 1
group by tmp.sid
order by count desc,tmp.sid;
</code></pre><p>但是，细想一下，好像这样做有点麻烦了，只是获取成绩第一的同学嘛，为啥要搞排名呢？除了第一，其他名词的排名不都浪费了么？</p>
<p>我们可以直接从成绩表中，按照课程分组，获取每个课程的最高成绩，然后回scores表查出每个课程最高成绩的同学的id，再统计个数不就完了嘛？</p>
<pre><code>select tmp2.sid, count(1) as count
from (select sc.cid,sc.sid,sc.score
      from (select sc.cid, max(sc.score) as max from scores sc group by sc.cid) tmp
             inner join scores sc on tmp.cid = sc.cid and tmp.max = sc.score) tmp2
group by tmp2.sid
order by count desc, tmp2.sid;
</code></pre><blockquote>
<p>来源：https://coolcao.com/2020/03/23/sql-test/</p>
</blockquote>

			</div><div class="content">
	<br>
	<img src="https://raw.githubusercontent.com/WillJE/WillJE.github.io/main/docs/wetchat-qrcode.png">
</div>

			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>472 字</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>0001-01-01 08:00 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://willje.github.io/posts/linux/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;新</span><br><span></span>
			</a>
			<a class="prev-post" href="https://willje.github.io/posts/other/concept/cncf/">
				<span class="post-nav-label">旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span></span>
			</a>
		</div>
		<div id="comments" class="thin"><script src="https://utteranc.es/client.js"
	repo="polaris1119/polarisxu"
	issue-term="pathname"
	theme="github-light"
	crossorigin="anonymous"
	async>
</script>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 - 2022 <a href="https://willje.github.io">will</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://willje.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://willje.github.io/js/main.min.4eaa15feccc672488716f0338ac605e08c7553ce0ce175e13fa00a873636bf98.js" integrity="sha256-TqoV/szGckiHFvAzisYF4Ix1U84M4XXhP6AKhzY2v5g=" crossorigin="anonymous"></script>
	<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?224c227cd9239761ec770bc8c1fb134c";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</body>

</html>
